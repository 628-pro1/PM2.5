---
title: "Project Progress Presentation-Group 3"
author: "Chenxi He, Wenxue Zhang, Yaqi Zhou"
date: "February 9, 2016"
output: beamer_presentation
---

```{r echo=FALSE, message=FALSE, warning=FALSE}
data <- read.csv("pro1-data.csv", header=TRUE)
library(ggplot2)
library(zoo)
library(scales)
library(gtable)
library(grid)
library(gridExtra)

```

# Introduction

Since 2013, shares in environment-related companies has been gaining momentum on Chinese stock market. The China Security Index Company created a **PM2.5-related industrial average** for continuous attention on the high-tech environmental companies' stock such like air quality instrumentation, filter presses, and separators. And the government issues specific policies which are beneficial to high-tech environmental companies. 

Thus, we are keenly interested in how the air quality affects the stock of those companies.

# Time-series Plot (blue: log_daverage; red: returns)

```{r echo=FALSE, fig.height=6, fig.width=10, fig.align='center'}
date <- paste0(data$Year,"-",data$Month,"-",data$Day)
data$date <- date
data$date <- as.Date(data$date, "%Y-%m-%d")



# Two plots overlapped; using returns and log(pm2.5)
grid.newpage()

# two plots
p1 <- ggplot(data, aes(date, log_daverage)) + geom_line(colour = "blue") + theme_bw() 
p2 <- ggplot(data, aes(date, returns)) + geom_line(colour = "red") + theme_bw() %+replace%
    theme(panel.background = element_rect(fill = NA))

# extract gtable
g1 <- ggplot_gtable(ggplot_build(p1))
g2 <- ggplot_gtable(ggplot_build(p2))

# overlap the panel of 2nd plot on that of 1st plot
pp <- c(subset(g1$layout, name == "panel", se = t:r))
g <- gtable_add_grob(g1, g2$grobs[[which(g2$layout$name == "panel")]], pp$t,
                     pp$l, pp$b, pp$l)

# axis tweaks
ia <- which(g2$layout$name == "axis-l")
ga <- g2$grobs[[ia]]
ax <- ga$children[[2]]
ax$widths <- rev(ax$widths)
ax$grobs <- rev(ax$grobs)
ax$grobs[[1]]$x <- ax$grobs[[1]]$x - unit(1, "npc") + unit(0.15, "cm")
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
g <- gtable_add_grob(g, ax, pp$t, length(g$widths) - 1, pp$b)
ia <- which(g2$layout$name == "ylab")
ga <- g2$grobs[[ia]]
ga$rot <- 270
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
g <- gtable_add_grob(g, ga, pp$t, length(g$widths) - 1, pp$b)

grid.draw(g)
```

# Time-series Plot for Year 2013 (January-April)
```{r echo=FALSE, fig.height=6, fig.width=10}
# Two plots overlapped; using returns and log_daverage for quarter 4 of 2013

data13 <- data[data$Year == 2013,]
jan13 <- data13[data13$Month == 1,]

# two plots
p1 <- ggplot(jan13, aes(Day, log_daverage, group=1)) + geom_line(colour = "blue") + theme_bw() + ggtitle("January")
p2 <- ggplot(jan13, aes(Day, returns, group=1)) + geom_line(colour = "red") + theme_bw() %+replace%
    theme(panel.background = element_rect(fill = NA))

# extract gtable
g1 <- ggplot_gtable(ggplot_build(p1))
g2 <- ggplot_gtable(ggplot_build(p2))

# overlap the panel of 2nd plot on that of 1st plot
pp <- c(subset(g1$layout, name == "panel", se = t:r))
g <- gtable_add_grob(g1, g2$grobs[[which(g2$layout$name == "panel")]], pp$t,
                     pp$l, pp$b, pp$l)

# axis tweaks
ia <- which(g2$layout$name == "axis-l")
ga <- g2$grobs[[ia]]
ax <- ga$children[[2]]
ax$widths <- rev(ax$widths)
ax$grobs <- rev(ax$grobs)
ax$grobs[[1]]$x <- ax$grobs[[1]]$x - unit(1, "npc") + unit(0.15, "cm")
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
g <- gtable_add_grob(g, ax, pp$t, length(g$widths) - 1, pp$b)
ia <- which(g2$layout$name == "ylab")
ga <- g2$grobs[[ia]]
ga$rot <- 270
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
gp1 <- gtable_add_grob(g, ga, pp$t, length(g$widths) - 1, pp$b)



####################################

feb13 <- data13[data13$Month == 2,]
# two plots
p1 <- ggplot(feb13, aes(Day, log_daverage, group=1)) + geom_line(colour = "blue") + theme_bw() + ggtitle("February")
p2 <- ggplot(feb13, aes(Day, returns, group=1)) + geom_line(colour = "red") + theme_bw() %+replace%
    theme(panel.background = element_rect(fill = NA))

# extract gtable
g1 <- ggplot_gtable(ggplot_build(p1))
g2 <- ggplot_gtable(ggplot_build(p2))

# overlap the panel of 2nd plot on that of 1st plot
pp <- c(subset(g1$layout, name == "panel", se = t:r))
g <- gtable_add_grob(g1, g2$grobs[[which(g2$layout$name == "panel")]], pp$t,
                     pp$l, pp$b, pp$l)

# axis tweaks
ia <- which(g2$layout$name == "axis-l")
ga <- g2$grobs[[ia]]
ax <- ga$children[[2]]
ax$widths <- rev(ax$widths)
ax$grobs <- rev(ax$grobs)
ax$grobs[[1]]$x <- ax$grobs[[1]]$x - unit(1, "npc") + unit(0.15, "cm")
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
g <- gtable_add_grob(g, ax, pp$t, length(g$widths) - 1, pp$b)
ia <- which(g2$layout$name == "ylab")
ga <- g2$grobs[[ia]]
ga$rot <- 270
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
gp2 <- gtable_add_grob(g, ga, pp$t, length(g$widths) - 1, pp$b)


####################################

mar13 <- data13[data13$Month == 3,]
# two plots
p1 <- ggplot(mar13, aes(Day, log_daverage, group=1)) + geom_line(colour = "blue") + theme_bw() + ggtitle("March")
p2 <- ggplot(mar13, aes(Day, returns, group=1)) + geom_line(colour = "red") + theme_bw() %+replace%
    theme(panel.background = element_rect(fill = NA))

# extract gtable
g1 <- ggplot_gtable(ggplot_build(p1))
g2 <- ggplot_gtable(ggplot_build(p2))

# overlap the panel of 2nd plot on that of 1st plot
pp <- c(subset(g1$layout, name == "panel", se = t:r))
g <- gtable_add_grob(g1, g2$grobs[[which(g2$layout$name == "panel")]], pp$t,
                     pp$l, pp$b, pp$l)

# axis tweaks
ia <- which(g2$layout$name == "axis-l")
ga <- g2$grobs[[ia]]
ax <- ga$children[[2]]
ax$widths <- rev(ax$widths)
ax$grobs <- rev(ax$grobs)
ax$grobs[[1]]$x <- ax$grobs[[1]]$x - unit(1, "npc") + unit(0.15, "cm")
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
g <- gtable_add_grob(g, ax, pp$t, length(g$widths) - 1, pp$b)
ia <- which(g2$layout$name == "ylab")
ga <- g2$grobs[[ia]]
ga$rot <- 270
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
gp3 <- gtable_add_grob(g, ga, pp$t, length(g$widths) - 1, pp$b)



####################################

apr13 <- data13[data13$Month == 4,]
# two plots
p1 <- ggplot(apr13, aes(Day, log_daverage, group=1)) + geom_line(colour = "blue") + theme_bw() + ggtitle("April")
p2 <- ggplot(apr13, aes(Day, returns, group=1)) + geom_line(colour = "red") + theme_bw() %+replace%
    theme(panel.background = element_rect(fill = NA))

# extract gtable
g1 <- ggplot_gtable(ggplot_build(p1))
g2 <- ggplot_gtable(ggplot_build(p2))

# overlap the panel of 2nd plot on that of 1st plot
pp <- c(subset(g1$layout, name == "panel", se = t:r))
g <- gtable_add_grob(g1, g2$grobs[[which(g2$layout$name == "panel")]], pp$t,
                     pp$l, pp$b, pp$l)

# axis tweaks
ia <- which(g2$layout$name == "axis-l")
ga <- g2$grobs[[ia]]
ax <- ga$children[[2]]
ax$widths <- rev(ax$widths)
ax$grobs <- rev(ax$grobs)
ax$grobs[[1]]$x <- ax$grobs[[1]]$x - unit(1, "npc") + unit(0.15, "cm")
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
g <- gtable_add_grob(g, ax, pp$t, length(g$widths) - 1, pp$b)
ia <- which(g2$layout$name == "ylab")
ga <- g2$grobs[[ia]]
ga$rot <- 270
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
gp4 <- gtable_add_grob(g, ga, pp$t, length(g$widths) - 1, pp$b)




grid.arrange(gp1, gp2, gp3, gp4, ncol=2,nrow=2)
```


# Time-series Plot for Year 2013 (May-August)

```{r echo=FALSE, fig.height=6, fig.width=10}
####################################

may13 <- data13[data13$Month == 5,]
# two plots
p1 <- ggplot(may13, aes(Day, log_daverage, group=1)) + geom_line(colour = "blue") + theme_bw() + ggtitle("May")
p2 <- ggplot(may13, aes(Day, returns, group=1)) + geom_line(colour = "red") + theme_bw() %+replace%
    theme(panel.background = element_rect(fill = NA))

# extract gtable
g1 <- ggplot_gtable(ggplot_build(p1))
g2 <- ggplot_gtable(ggplot_build(p2))

# overlap the panel of 2nd plot on that of 1st plot
pp <- c(subset(g1$layout, name == "panel", se = t:r))
g <- gtable_add_grob(g1, g2$grobs[[which(g2$layout$name == "panel")]], pp$t,
                     pp$l, pp$b, pp$l)

# axis tweaks
ia <- which(g2$layout$name == "axis-l")
ga <- g2$grobs[[ia]]
ax <- ga$children[[2]]
ax$widths <- rev(ax$widths)
ax$grobs <- rev(ax$grobs)
ax$grobs[[1]]$x <- ax$grobs[[1]]$x - unit(1, "npc") + unit(0.15, "cm")
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
g <- gtable_add_grob(g, ax, pp$t, length(g$widths) - 1, pp$b)
ia <- which(g2$layout$name == "ylab")
ga <- g2$grobs[[ia]]
ga$rot <- 270
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
gp5 <- gtable_add_grob(g, ga, pp$t, length(g$widths) - 1, pp$b)



####################################

jun13 <- data13[data13$Month == 6,]
# two plots
p1 <- ggplot(jun13, aes(Day, log_daverage, group=1)) + geom_line(colour = "blue") + theme_bw() + ggtitle("June")
p2 <- ggplot(jun13, aes(Day, returns, group=1)) + geom_line(colour = "red") + theme_bw() %+replace%
    theme(panel.background = element_rect(fill = NA))

# extract gtable
g1 <- ggplot_gtable(ggplot_build(p1))
g2 <- ggplot_gtable(ggplot_build(p2))

# overlap the panel of 2nd plot on that of 1st plot
pp <- c(subset(g1$layout, name == "panel", se = t:r))
g <- gtable_add_grob(g1, g2$grobs[[which(g2$layout$name == "panel")]], pp$t,
                     pp$l, pp$b, pp$l)

# axis tweaks
ia <- which(g2$layout$name == "axis-l")
ga <- g2$grobs[[ia]]
ax <- ga$children[[2]]
ax$widths <- rev(ax$widths)
ax$grobs <- rev(ax$grobs)
ax$grobs[[1]]$x <- ax$grobs[[1]]$x - unit(1, "npc") + unit(0.15, "cm")
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
g <- gtable_add_grob(g, ax, pp$t, length(g$widths) - 1, pp$b)
ia <- which(g2$layout$name == "ylab")
ga <- g2$grobs[[ia]]
ga$rot <- 270
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
gp6 <- gtable_add_grob(g, ga, pp$t, length(g$widths) - 1, pp$b)



####################################

jul13 <- data13[data13$Month == 7,]
# two plots
p1 <- ggplot(jul13, aes(Day, log_daverage, group=1)) + geom_line(colour = "blue") + theme_bw() + ggtitle("July")
p2 <- ggplot(jul13, aes(Day, returns, group=1)) + geom_line(colour = "red") + theme_bw() %+replace%
    theme(panel.background = element_rect(fill = NA))

# extract gtable
g1 <- ggplot_gtable(ggplot_build(p1))
g2 <- ggplot_gtable(ggplot_build(p2))

# overlap the panel of 2nd plot on that of 1st plot
pp <- c(subset(g1$layout, name == "panel", se = t:r))
g <- gtable_add_grob(g1, g2$grobs[[which(g2$layout$name == "panel")]], pp$t,
                     pp$l, pp$b, pp$l)

# axis tweaks
ia <- which(g2$layout$name == "axis-l")
ga <- g2$grobs[[ia]]
ax <- ga$children[[2]]
ax$widths <- rev(ax$widths)
ax$grobs <- rev(ax$grobs)
ax$grobs[[1]]$x <- ax$grobs[[1]]$x - unit(1, "npc") + unit(0.15, "cm")
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
g <- gtable_add_grob(g, ax, pp$t, length(g$widths) - 1, pp$b)
ia <- which(g2$layout$name == "ylab")
ga <- g2$grobs[[ia]]
ga$rot <- 270
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
gp7 <- gtable_add_grob(g, ga, pp$t, length(g$widths) - 1, pp$b)



####################################

aug13 <- data13[data13$Month == 8,]
# two plots
p1 <- ggplot(aug13, aes(Day, log_daverage, group=1)) + geom_line(colour = "blue") + theme_bw() + ggtitle("August")
p2 <- ggplot(aug13, aes(Day, returns, group=1)) + geom_line(colour = "red") + theme_bw() %+replace%
    theme(panel.background = element_rect(fill = NA))

# extract gtable
g1 <- ggplot_gtable(ggplot_build(p1))
g2 <- ggplot_gtable(ggplot_build(p2))

# overlap the panel of 2nd plot on that of 1st plot
pp <- c(subset(g1$layout, name == "panel", se = t:r))
g <- gtable_add_grob(g1, g2$grobs[[which(g2$layout$name == "panel")]], pp$t,
                     pp$l, pp$b, pp$l)

# axis tweaks
ia <- which(g2$layout$name == "axis-l")
ga <- g2$grobs[[ia]]
ax <- ga$children[[2]]
ax$widths <- rev(ax$widths)
ax$grobs <- rev(ax$grobs)
ax$grobs[[1]]$x <- ax$grobs[[1]]$x - unit(1, "npc") + unit(0.15, "cm")
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
g <- gtable_add_grob(g, ax, pp$t, length(g$widths) - 1, pp$b)
ia <- which(g2$layout$name == "ylab")
ga <- g2$grobs[[ia]]
ga$rot <- 270
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
gp8 <- gtable_add_grob(g, ga, pp$t, length(g$widths) - 1, pp$b)

grid.arrange(gp5, gp6, gp7, gp8, ncol=2,nrow=2)
```

# Time-series Plot for Year 2013 (September-December)
```{r echo=FALSE, fig.height=6, fig.width=10}
 
####################################

sep13 <- data13[data13$Month == 9,]
# two plots
p1 <- ggplot(sep13, aes(Day, log_daverage, group=1)) + geom_line(colour = "blue") + theme_bw() + ggtitle("September")
p2 <- ggplot(sep13, aes(Day, returns, group=1)) + geom_line(colour = "red") + theme_bw() %+replace%
    theme(panel.background = element_rect(fill = NA))

# extract gtable
g1 <- ggplot_gtable(ggplot_build(p1))
g2 <- ggplot_gtable(ggplot_build(p2))

# overlap the panel of 2nd plot on that of 1st plot
pp <- c(subset(g1$layout, name == "panel", se = t:r))
g <- gtable_add_grob(g1, g2$grobs[[which(g2$layout$name == "panel")]], pp$t,
                     pp$l, pp$b, pp$l)

# axis tweaks
ia <- which(g2$layout$name == "axis-l")
ga <- g2$grobs[[ia]]
ax <- ga$children[[2]]
ax$widths <- rev(ax$widths)
ax$grobs <- rev(ax$grobs)
ax$grobs[[1]]$x <- ax$grobs[[1]]$x - unit(1, "npc") + unit(0.15, "cm")
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
g <- gtable_add_grob(g, ax, pp$t, length(g$widths) - 1, pp$b)
ia <- which(g2$layout$name == "ylab")
ga <- g2$grobs[[ia]]
ga$rot <- 270
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
gp9 <- gtable_add_grob(g, ga, pp$t, length(g$widths) - 1, pp$b)



####################################

oct13 <- data13[data13$Month == 10,]
# two plots
p1 <- ggplot(oct13, aes(Day, log_daverage, group=1)) + geom_line(colour = "blue") + theme_bw() + ggtitle("October")
p2 <- ggplot(oct13, aes(Day, returns, group=1)) + geom_line(colour = "red") + theme_bw() %+replace%
    theme(panel.background = element_rect(fill = NA))

# extract gtable
g1 <- ggplot_gtable(ggplot_build(p1))
g2 <- ggplot_gtable(ggplot_build(p2))

# overlap the panel of 2nd plot on that of 1st plot
pp <- c(subset(g1$layout, name == "panel", se = t:r))
g <- gtable_add_grob(g1, g2$grobs[[which(g2$layout$name == "panel")]], pp$t,
                     pp$l, pp$b, pp$l)

# axis tweaks
ia <- which(g2$layout$name == "axis-l")
ga <- g2$grobs[[ia]]
ax <- ga$children[[2]]
ax$widths <- rev(ax$widths)
ax$grobs <- rev(ax$grobs)
ax$grobs[[1]]$x <- ax$grobs[[1]]$x - unit(1, "npc") + unit(0.15, "cm")
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
g <- gtable_add_grob(g, ax, pp$t, length(g$widths) - 1, pp$b)
ia <- which(g2$layout$name == "ylab")
ga <- g2$grobs[[ia]]
ga$rot <- 270
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
gp10 <- gtable_add_grob(g, ga, pp$t, length(g$widths) - 1, pp$b)



####################################

nov13 <- data13[data13$Month == 11,]
# two plots
p1 <- ggplot(nov13, aes(Day, log_daverage, group=1)) + geom_line(colour = "blue") + theme_bw() + ggtitle("November")
p2 <- ggplot(nov13, aes(Day, returns, group=1)) + geom_line(colour = "red") + theme_bw() %+replace%
    theme(panel.background = element_rect(fill = NA))

# extract gtable
g1 <- ggplot_gtable(ggplot_build(p1))
g2 <- ggplot_gtable(ggplot_build(p2))

# overlap the panel of 2nd plot on that of 1st plot
pp <- c(subset(g1$layout, name == "panel", se = t:r))
g <- gtable_add_grob(g1, g2$grobs[[which(g2$layout$name == "panel")]], pp$t,
                     pp$l, pp$b, pp$l)

# axis tweaks
ia <- which(g2$layout$name == "axis-l")
ga <- g2$grobs[[ia]]
ax <- ga$children[[2]]
ax$widths <- rev(ax$widths)
ax$grobs <- rev(ax$grobs)
ax$grobs[[1]]$x <- ax$grobs[[1]]$x - unit(1, "npc") + unit(0.15, "cm")
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
g <- gtable_add_grob(g, ax, pp$t, length(g$widths) - 1, pp$b)
ia <- which(g2$layout$name == "ylab")
ga <- g2$grobs[[ia]]
ga$rot <- 270
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
gp11 <- gtable_add_grob(g, ga, pp$t, length(g$widths) - 1, pp$b)



####################################

dec13 <- data13[data13$Month == 12,]
# two plots
p1 <- ggplot(dec13, aes(Day, log_daverage, group=1)) + geom_line(colour = "blue") + theme_bw() + ggtitle("December")
p2 <- ggplot(dec13, aes(Day, returns, group=1)) + geom_line(colour = "red") + theme_bw() %+replace%
    theme(panel.background = element_rect(fill = NA))

# extract gtable
g1 <- ggplot_gtable(ggplot_build(p1))
g2 <- ggplot_gtable(ggplot_build(p2))

# overlap the panel of 2nd plot on that of 1st plot
pp <- c(subset(g1$layout, name == "panel", se = t:r))
g <- gtable_add_grob(g1, g2$grobs[[which(g2$layout$name == "panel")]], pp$t,
                     pp$l, pp$b, pp$l)

# axis tweaks
ia <- which(g2$layout$name == "axis-l")
ga <- g2$grobs[[ia]]
ax <- ga$children[[2]]
ax$widths <- rev(ax$widths)
ax$grobs <- rev(ax$grobs)
ax$grobs[[1]]$x <- ax$grobs[[1]]$x - unit(1, "npc") + unit(0.15, "cm")
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
g <- gtable_add_grob(g, ax, pp$t, length(g$widths) - 1, pp$b)
ia <- which(g2$layout$name == "ylab")
ga <- g2$grobs[[ia]]
ga$rot <- 270
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
gp12 <- gtable_add_grob(g, ga, pp$t, length(g$widths) - 1, pp$b)

grid.arrange(gp9, gp10, gp11, gp12, ncol=2,nrow=2)
```

# Time-series Plot for Year 2014 (January-April)
```{r echo=FALSE, fig.height=6, fig.width=10}
# Two plots overlapped; using returns and log_daverage for quarter 4 of 2013

data14 <- data[data$Year == 2014,]
jan14 <- data14[data14$Month == 1,]

# two plots
p1 <- ggplot(jan14, aes(Day, log_daverage, group=1)) + geom_line(colour = "blue") + theme_bw() + ggtitle("January")
p2 <- ggplot(jan14, aes(Day, returns, group=1)) + geom_line(colour = "red") + theme_bw() %+replace%
    theme(panel.background = element_rect(fill = NA))

# extract gtable
g1 <- ggplot_gtable(ggplot_build(p1))
g2 <- ggplot_gtable(ggplot_build(p2))

# overlap the panel of 2nd plot on that of 1st plot
pp <- c(subset(g1$layout, name == "panel", se = t:r))
g <- gtable_add_grob(g1, g2$grobs[[which(g2$layout$name == "panel")]], pp$t,
                     pp$l, pp$b, pp$l)

# axis tweaks
ia <- which(g2$layout$name == "axis-l")
ga <- g2$grobs[[ia]]
ax <- ga$children[[2]]
ax$widths <- rev(ax$widths)
ax$grobs <- rev(ax$grobs)
ax$grobs[[1]]$x <- ax$grobs[[1]]$x - unit(1, "npc") + unit(0.15, "cm")
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
g <- gtable_add_grob(g, ax, pp$t, length(g$widths) - 1, pp$b)
ia <- which(g2$layout$name == "ylab")
ga <- g2$grobs[[ia]]
ga$rot <- 270
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
gp1 <- gtable_add_grob(g, ga, pp$t, length(g$widths) - 1, pp$b)



####################################

feb14 <- data14[data14$Month == 2,]
# two plots
p1 <- ggplot(feb14, aes(Day, log_daverage, group=1)) + geom_line(colour = "blue") + theme_bw() + ggtitle("February")
p2 <- ggplot(feb14, aes(Day, returns, group=1)) + geom_line(colour = "red") + theme_bw() %+replace%
    theme(panel.background = element_rect(fill = NA))

# extract gtable
g1 <- ggplot_gtable(ggplot_build(p1))
g2 <- ggplot_gtable(ggplot_build(p2))

# overlap the panel of 2nd plot on that of 1st plot
pp <- c(subset(g1$layout, name == "panel", se = t:r))
g <- gtable_add_grob(g1, g2$grobs[[which(g2$layout$name == "panel")]], pp$t,
                     pp$l, pp$b, pp$l)

# axis tweaks
ia <- which(g2$layout$name == "axis-l")
ga <- g2$grobs[[ia]]
ax <- ga$children[[2]]
ax$widths <- rev(ax$widths)
ax$grobs <- rev(ax$grobs)
ax$grobs[[1]]$x <- ax$grobs[[1]]$x - unit(1, "npc") + unit(0.15, "cm")
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
g <- gtable_add_grob(g, ax, pp$t, length(g$widths) - 1, pp$b)
ia <- which(g2$layout$name == "ylab")
ga <- g2$grobs[[ia]]
ga$rot <- 270
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
gp2 <- gtable_add_grob(g, ga, pp$t, length(g$widths) - 1, pp$b)


####################################

mar14 <- data14[data14$Month == 3,]
# two plots
p1 <- ggplot(mar14, aes(Day, log_daverage, group=1)) + geom_line(colour = "blue") + theme_bw() + ggtitle("March")
p2 <- ggplot(mar14, aes(Day, returns, group=1)) + geom_line(colour = "red") + theme_bw() %+replace%
    theme(panel.background = element_rect(fill = NA))

# extract gtable
g1 <- ggplot_gtable(ggplot_build(p1))
g2 <- ggplot_gtable(ggplot_build(p2))

# overlap the panel of 2nd plot on that of 1st plot
pp <- c(subset(g1$layout, name == "panel", se = t:r))
g <- gtable_add_grob(g1, g2$grobs[[which(g2$layout$name == "panel")]], pp$t,
                     pp$l, pp$b, pp$l)

# axis tweaks
ia <- which(g2$layout$name == "axis-l")
ga <- g2$grobs[[ia]]
ax <- ga$children[[2]]
ax$widths <- rev(ax$widths)
ax$grobs <- rev(ax$grobs)
ax$grobs[[1]]$x <- ax$grobs[[1]]$x - unit(1, "npc") + unit(0.15, "cm")
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
g <- gtable_add_grob(g, ax, pp$t, length(g$widths) - 1, pp$b)
ia <- which(g2$layout$name == "ylab")
ga <- g2$grobs[[ia]]
ga$rot <- 270
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
gp3 <- gtable_add_grob(g, ga, pp$t, length(g$widths) - 1, pp$b)



####################################

apr14 <- data14[data14$Month == 4,]
# two plots
p1 <- ggplot(apr14, aes(Day, log_daverage, group=1)) + geom_line(colour = "blue") + theme_bw() + ggtitle("April")
p2 <- ggplot(apr14, aes(Day, returns, group=1)) + geom_line(colour = "red") + theme_bw() %+replace%
    theme(panel.background = element_rect(fill = NA))

# extract gtable
g1 <- ggplot_gtable(ggplot_build(p1))
g2 <- ggplot_gtable(ggplot_build(p2))

# overlap the panel of 2nd plot on that of 1st plot
pp <- c(subset(g1$layout, name == "panel", se = t:r))
g <- gtable_add_grob(g1, g2$grobs[[which(g2$layout$name == "panel")]], pp$t,
                     pp$l, pp$b, pp$l)

# axis tweaks
ia <- which(g2$layout$name == "axis-l")
ga <- g2$grobs[[ia]]
ax <- ga$children[[2]]
ax$widths <- rev(ax$widths)
ax$grobs <- rev(ax$grobs)
ax$grobs[[1]]$x <- ax$grobs[[1]]$x - unit(1, "npc") + unit(0.15, "cm")
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
g <- gtable_add_grob(g, ax, pp$t, length(g$widths) - 1, pp$b)
ia <- which(g2$layout$name == "ylab")
ga <- g2$grobs[[ia]]
ga$rot <- 270
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
gp4 <- gtable_add_grob(g, ga, pp$t, length(g$widths) - 1, pp$b)




grid.arrange(gp1, gp2, gp3, gp4, ncol=2,nrow=2)
```


# Time-series Plot for Year 2014 (May-August)

```{r echo=FALSE, fig.height=6, fig.width=10}
####################################

may14 <- data14[data14$Month == 5,]
# two plots
p1 <- ggplot(may14, aes(Day, log_daverage, group=1)) + geom_line(colour = "blue") + theme_bw() + ggtitle("May")
p2 <- ggplot(may14, aes(Day, returns, group=1)) + geom_line(colour = "red") + theme_bw() %+replace%
    theme(panel.background = element_rect(fill = NA))

# extract gtable
g1 <- ggplot_gtable(ggplot_build(p1))
g2 <- ggplot_gtable(ggplot_build(p2))

# overlap the panel of 2nd plot on that of 1st plot
pp <- c(subset(g1$layout, name == "panel", se = t:r))
g <- gtable_add_grob(g1, g2$grobs[[which(g2$layout$name == "panel")]], pp$t,
                     pp$l, pp$b, pp$l)

# axis tweaks
ia <- which(g2$layout$name == "axis-l")
ga <- g2$grobs[[ia]]
ax <- ga$children[[2]]
ax$widths <- rev(ax$widths)
ax$grobs <- rev(ax$grobs)
ax$grobs[[1]]$x <- ax$grobs[[1]]$x - unit(1, "npc") + unit(0.15, "cm")
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
g <- gtable_add_grob(g, ax, pp$t, length(g$widths) - 1, pp$b)
ia <- which(g2$layout$name == "ylab")
ga <- g2$grobs[[ia]]
ga$rot <- 270
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
gp5 <- gtable_add_grob(g, ga, pp$t, length(g$widths) - 1, pp$b)



####################################

jun14 <- data14[data14$Month == 6,]
# two plots
p1 <- ggplot(jun14, aes(Day, log_daverage, group=1)) + geom_line(colour = "blue") + theme_bw() + ggtitle("June")
p2 <- ggplot(jun14, aes(Day, returns, group=1)) + geom_line(colour = "red") + theme_bw() %+replace%
    theme(panel.background = element_rect(fill = NA))

# extract gtable
g1 <- ggplot_gtable(ggplot_build(p1))
g2 <- ggplot_gtable(ggplot_build(p2))

# overlap the panel of 2nd plot on that of 1st plot
pp <- c(subset(g1$layout, name == "panel", se = t:r))
g <- gtable_add_grob(g1, g2$grobs[[which(g2$layout$name == "panel")]], pp$t,
                     pp$l, pp$b, pp$l)

# axis tweaks
ia <- which(g2$layout$name == "axis-l")
ga <- g2$grobs[[ia]]
ax <- ga$children[[2]]
ax$widths <- rev(ax$widths)
ax$grobs <- rev(ax$grobs)
ax$grobs[[1]]$x <- ax$grobs[[1]]$x - unit(1, "npc") + unit(0.15, "cm")
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
g <- gtable_add_grob(g, ax, pp$t, length(g$widths) - 1, pp$b)
ia <- which(g2$layout$name == "ylab")
ga <- g2$grobs[[ia]]
ga$rot <- 270
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
gp6 <- gtable_add_grob(g, ga, pp$t, length(g$widths) - 1, pp$b)



####################################

jul14 <- data14[data14$Month == 7,]
# two plots
p1 <- ggplot(jul14, aes(Day, log_daverage, group=1)) + geom_line(colour = "blue") + theme_bw() + ggtitle("July")
p2 <- ggplot(jul14, aes(Day, returns, group=1)) + geom_line(colour = "red") + theme_bw() %+replace%
    theme(panel.background = element_rect(fill = NA))

# extract gtable
g1 <- ggplot_gtable(ggplot_build(p1))
g2 <- ggplot_gtable(ggplot_build(p2))

# overlap the panel of 2nd plot on that of 1st plot
pp <- c(subset(g1$layout, name == "panel", se = t:r))
g <- gtable_add_grob(g1, g2$grobs[[which(g2$layout$name == "panel")]], pp$t,
                     pp$l, pp$b, pp$l)

# axis tweaks
ia <- which(g2$layout$name == "axis-l")
ga <- g2$grobs[[ia]]
ax <- ga$children[[2]]
ax$widths <- rev(ax$widths)
ax$grobs <- rev(ax$grobs)
ax$grobs[[1]]$x <- ax$grobs[[1]]$x - unit(1, "npc") + unit(0.15, "cm")
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
g <- gtable_add_grob(g, ax, pp$t, length(g$widths) - 1, pp$b)
ia <- which(g2$layout$name == "ylab")
ga <- g2$grobs[[ia]]
ga$rot <- 270
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
gp7 <- gtable_add_grob(g, ga, pp$t, length(g$widths) - 1, pp$b)



####################################

aug14 <- data14[data14$Month == 8,]
# two plots
p1 <- ggplot(aug14, aes(Day, log_daverage, group=1)) + geom_line(colour = "blue") + theme_bw() + ggtitle("August")
p2 <- ggplot(aug14, aes(Day, returns, group=1)) + geom_line(colour = "red") + theme_bw() %+replace%
    theme(panel.background = element_rect(fill = NA))

# extract gtable
g1 <- ggplot_gtable(ggplot_build(p1))
g2 <- ggplot_gtable(ggplot_build(p2))

# overlap the panel of 2nd plot on that of 1st plot
pp <- c(subset(g1$layout, name == "panel", se = t:r))
g <- gtable_add_grob(g1, g2$grobs[[which(g2$layout$name == "panel")]], pp$t,
                     pp$l, pp$b, pp$l)

# axis tweaks
ia <- which(g2$layout$name == "axis-l")
ga <- g2$grobs[[ia]]
ax <- ga$children[[2]]
ax$widths <- rev(ax$widths)
ax$grobs <- rev(ax$grobs)
ax$grobs[[1]]$x <- ax$grobs[[1]]$x - unit(1, "npc") + unit(0.15, "cm")
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
g <- gtable_add_grob(g, ax, pp$t, length(g$widths) - 1, pp$b)
ia <- which(g2$layout$name == "ylab")
ga <- g2$grobs[[ia]]
ga$rot <- 270
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
gp8 <- gtable_add_grob(g, ga, pp$t, length(g$widths) - 1, pp$b)

grid.arrange(gp5, gp6, gp7, gp8, ncol=2,nrow=2)
```

# Time-series Plot for Year 2014 (September-December)
```{r echo=FALSE, fig.height=6, fig.width=10}
 
####################################

sep14 <- data14[data14$Month == 9,]
# two plots
p1 <- ggplot(sep14, aes(Day, log_daverage, group=1)) + geom_line(colour = "blue") + theme_bw() + ggtitle("September")
p2 <- ggplot(sep14, aes(Day, returns, group=1)) + geom_line(colour = "red") + theme_bw() %+replace%
    theme(panel.background = element_rect(fill = NA))

# extract gtable
g1 <- ggplot_gtable(ggplot_build(p1))
g2 <- ggplot_gtable(ggplot_build(p2))

# overlap the panel of 2nd plot on that of 1st plot
pp <- c(subset(g1$layout, name == "panel", se = t:r))
g <- gtable_add_grob(g1, g2$grobs[[which(g2$layout$name == "panel")]], pp$t,
                     pp$l, pp$b, pp$l)

# axis tweaks
ia <- which(g2$layout$name == "axis-l")
ga <- g2$grobs[[ia]]
ax <- ga$children[[2]]
ax$widths <- rev(ax$widths)
ax$grobs <- rev(ax$grobs)
ax$grobs[[1]]$x <- ax$grobs[[1]]$x - unit(1, "npc") + unit(0.15, "cm")
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
g <- gtable_add_grob(g, ax, pp$t, length(g$widths) - 1, pp$b)
ia <- which(g2$layout$name == "ylab")
ga <- g2$grobs[[ia]]
ga$rot <- 270
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
gp9 <- gtable_add_grob(g, ga, pp$t, length(g$widths) - 1, pp$b)



####################################

oct14 <- data14[data14$Month == 10,]
# two plots
p1 <- ggplot(oct14, aes(Day, log_daverage, group=1)) + geom_line(colour = "blue") + theme_bw() + ggtitle("October")
p2 <- ggplot(oct14, aes(Day, returns, group=1)) + geom_line(colour = "red") + theme_bw() %+replace%
    theme(panel.background = element_rect(fill = NA))

# extract gtable
g1 <- ggplot_gtable(ggplot_build(p1))
g2 <- ggplot_gtable(ggplot_build(p2))

# overlap the panel of 2nd plot on that of 1st plot
pp <- c(subset(g1$layout, name == "panel", se = t:r))
g <- gtable_add_grob(g1, g2$grobs[[which(g2$layout$name == "panel")]], pp$t,
                     pp$l, pp$b, pp$l)

# axis tweaks
ia <- which(g2$layout$name == "axis-l")
ga <- g2$grobs[[ia]]
ax <- ga$children[[2]]
ax$widths <- rev(ax$widths)
ax$grobs <- rev(ax$grobs)
ax$grobs[[1]]$x <- ax$grobs[[1]]$x - unit(1, "npc") + unit(0.15, "cm")
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
g <- gtable_add_grob(g, ax, pp$t, length(g$widths) - 1, pp$b)
ia <- which(g2$layout$name == "ylab")
ga <- g2$grobs[[ia]]
ga$rot <- 270
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
gp10 <- gtable_add_grob(g, ga, pp$t, length(g$widths) - 1, pp$b)



####################################

nov14 <- data14[data14$Month == 11,]
# two plots
p1 <- ggplot(nov14, aes(Day, log_daverage, group=1)) + geom_line(colour = "blue") + theme_bw() + ggtitle("November")
p2 <- ggplot(nov14, aes(Day, returns, group=1)) + geom_line(colour = "red") + theme_bw() %+replace%
    theme(panel.background = element_rect(fill = NA))

# extract gtable
g1 <- ggplot_gtable(ggplot_build(p1))
g2 <- ggplot_gtable(ggplot_build(p2))

# overlap the panel of 2nd plot on that of 1st plot
pp <- c(subset(g1$layout, name == "panel", se = t:r))
g <- gtable_add_grob(g1, g2$grobs[[which(g2$layout$name == "panel")]], pp$t,
                     pp$l, pp$b, pp$l)

# axis tweaks
ia <- which(g2$layout$name == "axis-l")
ga <- g2$grobs[[ia]]
ax <- ga$children[[2]]
ax$widths <- rev(ax$widths)
ax$grobs <- rev(ax$grobs)
ax$grobs[[1]]$x <- ax$grobs[[1]]$x - unit(1, "npc") + unit(0.15, "cm")
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
g <- gtable_add_grob(g, ax, pp$t, length(g$widths) - 1, pp$b)
ia <- which(g2$layout$name == "ylab")
ga <- g2$grobs[[ia]]
ga$rot <- 270
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
gp11 <- gtable_add_grob(g, ga, pp$t, length(g$widths) - 1, pp$b)



####################################

dec14 <- data14[data14$Month == 12,]
# two plots
p1 <- ggplot(dec14, aes(Day, log_daverage, group=1)) + geom_line(colour = "blue") + theme_bw() + ggtitle("December")
p2 <- ggplot(dec14, aes(Day, returns, group=1)) + geom_line(colour = "red") + theme_bw() %+replace%
    theme(panel.background = element_rect(fill = NA))

# extract gtable
g1 <- ggplot_gtable(ggplot_build(p1))
g2 <- ggplot_gtable(ggplot_build(p2))

# overlap the panel of 2nd plot on that of 1st plot
pp <- c(subset(g1$layout, name == "panel", se = t:r))
g <- gtable_add_grob(g1, g2$grobs[[which(g2$layout$name == "panel")]], pp$t,
                     pp$l, pp$b, pp$l)

# axis tweaks
ia <- which(g2$layout$name == "axis-l")
ga <- g2$grobs[[ia]]
ax <- ga$children[[2]]
ax$widths <- rev(ax$widths)
ax$grobs <- rev(ax$grobs)
ax$grobs[[1]]$x <- ax$grobs[[1]]$x - unit(1, "npc") + unit(0.15, "cm")
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
g <- gtable_add_grob(g, ax, pp$t, length(g$widths) - 1, pp$b)
ia <- which(g2$layout$name == "ylab")
ga <- g2$grobs[[ia]]
ga$rot <- 270
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
gp12 <- gtable_add_grob(g, ga, pp$t, length(g$widths) - 1, pp$b)

grid.arrange(gp9, gp10, gp11, gp12, ncol=2,nrow=2)
```


# VAR model and basic steps

The vector autoregression (VAR) is an econometric model used to capture the linear interdependencies among multiple time series. Here is a VAR(1)
model in two variables.

$\left(\begin{array}{c} y_{1,t} \\ y_{2,t} \end{array}\right)=\left(\begin{array}{c} c_{1} \\ c_{2} \end{array}\right)+\left(\begin{array}{c} a_{1,1} \ a_{1,2} \\ a_{2,1} \ a_{2,2} \end{array}\right) \left(\begin{array}{c} y_{1,t-1} \\ y_{2,t-1} \end{array}\right)+\left(\begin{array}{c} \epsilon_{1,t} \\ \epsilon_{2,t} \end{array}\right)$

A time series X is said to Granger-cause Y if it can be shown, usually through a series of t-tests and F-tests on lagged values of X (and with lagged values of Y also included), that those X values provide statistically significant information about future values of Y.

Here are the basic steps:

- ADF test
- Lag selection (AIC)
- Granger causality test


# Test Result based on annual data
```{r results='asis',echo=FALSE,message=FALSE,warning=FALSE}
library(vars)
library(fUnitRoots)
library(tseries)
require(lubridate)
library(ggplot2)
library(dplyr)

data=read.csv("pro1-data.csv")
data$Date=as.Date(data$Date)
data=data[,c(-9,-10)]
#table(is.na(data))
data13=data[1:238,]
data14=data[year(data$Date)==2014,]
data15=data[year(data$Date)==2015,]

air_sec <- data.frame(airindex=ts(data13$log_daverage),stockret=ts(data13$returns))

#VARselect(air_sec,lag.max = 10,type = "both")
vmodel<-VAR(air_sec,1,type = "both")
#causality(vmodel,cause = "airindex")

air_sec <- data.frame(airindex=ts(data14$log_daverage),stockret=ts(data14$returns))

#VARselect(air_sec,lag.max = 10,type = "both")
vmodel<-VAR(air_sec,2,type = "both")
#causality(vmodel,cause = "airindex")

air_sec <- data.frame(airindex=ts(data15$log_daverage),stockret=ts(data15$returns))

#VARselect(air_sec,lag.max = 10,type = "both")
vmodel<-VAR(air_sec,3,type = "both")
#causality(vmodel,cause = "airindex")

library(knitr)
Year<-c("2013","2014","2015")
ADFtest<-rep("stationary",3)
Lag<-c(1:3)
Granger<-c("significant","not significant","not significant")
b<-data.frame(Year,ADFtest,Lag,Granger)
knitr::kable(head(b),align="c")
```

```{r,echo=FALSE,message=FALSE,warning=FALSE}


monthly_granger=function(y=2013){
  dy=data[year(data$Date)==y,]
  p=c(1:12)
  for(i in 1:12){
    d=dy[month(dy$Date)==i,]
    air_sec <- data.frame(airindex=ts(d$log_daverage),stockret=ts(d$returns))
    xx=VARselect(air_sec,lag.max = 10,type = "both")
    xxx=as.numeric(xx$selection[[1]])
    vmodel<-VAR(air_sec,xxx,type = "both")
    x=causality(vmodel,cause = "airindex")
    p[i]=x$Instant$p.value
  }
  return(p)
}
```

```{r,echo=FALSE,message=FALSE,warning=FALSE}

```

# Monthly Granger test

```{r,echo=FALSE,message=FALSE,warning=FALSE,fig.align='center'}
sum_ns <- data %>%
  group_by(Month,Year) %>%
  summarise(sum(ns)) %>%
  ungroup() %>%
  arrange(Year,Month)
colnames(sum_ns)[3]<-"ns_month"
month<-rep(1:12,3)
year<-rep(2013:2015,each=12)
p.value=c(monthly_granger(2013),monthly_granger(2014),monthly_granger(2015))
a<-data.frame(month=month,p.value=p.value,pollution=sum_ns$ns_month,year=year)
a$month<-as.factor(a$month)
ggplot(data=a,aes(x=month,y=p.value,size=pollution,color=pollution)) + geom_point() + geom_hline(yintercept=0.05,color="red") + ggtitle("Granger test results for each month") + facet_wrap(~year)

```

# July 2013

```{r fig.width=6, fig.height=3, fig.align='center', echo=FALSE}
jul13 <- data13[data13$Month == 7,]
# two plots
p1 <- ggplot(jul13, aes(Day, log_daverage, group=1)) + geom_line(colour = "blue") + theme_bw() + ggtitle("July")
p2 <- ggplot(jul13, aes(Day, returns, group=1)) + geom_line(colour = "red") + theme_bw() %+replace%
    theme(panel.background = element_rect(fill = NA))

# extract gtable
g1 <- ggplot_gtable(ggplot_build(p1))
g2 <- ggplot_gtable(ggplot_build(p2))

# overlap the panel of 2nd plot on that of 1st plot
pp <- c(subset(g1$layout, name == "panel", se = t:r))
g <- gtable_add_grob(g1, g2$grobs[[which(g2$layout$name == "panel")]], pp$t,
                     pp$l, pp$b, pp$l)

# axis tweaks
ia <- which(g2$layout$name == "axis-l")
ga <- g2$grobs[[ia]]
ax <- ga$children[[2]]
ax$widths <- rev(ax$widths)
ax$grobs <- rev(ax$grobs)
ax$grobs[[1]]$x <- ax$grobs[[1]]$x - unit(1, "npc") + unit(0.15, "cm")
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
g <- gtable_add_grob(g, ax, pp$t, length(g$widths) - 1, pp$b)
ia <- which(g2$layout$name == "ylab")
ga <- g2$grobs[[ia]]
ga$rot <- 270
g <- gtable_add_cols(g, g2$widths[g2$layout[ia, ]$l], length(g$widths) - 1)
gp7 <- gtable_add_grob(g, ga, pp$t, length(g$widths) - 1, pp$b)

grid.draw(gp7)
```